
services:
  # PostgreSQL with pgvector extension
  db:
    image: pgvector/pgvector:0.8.1-pg17-trixie
    container_name: agmem_postgres
    restart: always
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user-name}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-strong-password}
      POSTGRES_DB: ${POSTGRES_DATABASE:-agenticMermoryDB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-user-name} -d ${POSTGRES_DATABASE:-agenticMermoryDB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin for PostgreSQL management
  pgadmin:
    image: dpage/pgadmin4:snapshot
    container_name: agmem_pgadmin
    restart: always
    ports:
      - "8889:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@agmem.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-strong-password}
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - db

  # Neo4j Graph Database
  neo4j:
    image: neo4j:latest
    container_name: agmem_neo4j
    restart: always
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-strong-password}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD", "neo4j", "status"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: agmem_qdrant
    restart: always
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:latest
    container_name: agmem_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FalkorDB Graph Database (Redis-compatible)
  # Note: FalkorDB uses port 6379 by default (same as Redis)
  # Use different ports if running both Redis and FalkorDB
  falkordb:
    image: falkordb/falkordb:latest
    container_name: agmem_falkordb
    restart: unless-stopped
    ports:
      - "${FALKORDB_PORT:-6380}:6379"  # Map to 6380 to avoid conflict with Redis
      - "3000:3000"  # FalkorDB Browser UI
    volumes:
      - falkordb_data:/data
    environment:
      FALKORDB_ARGS: "--save 60 1"
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - falkordb  # Only start with --profile falkordb

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_plugins:
    driver: local
  qdrant_storage:
    driver: local
  redis_data:
    driver: local
  falkordb_data:
    driver: local

networks:
  default:
    name: agmem_network
    driver: bridge

